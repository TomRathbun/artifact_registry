# 1. Token (if expired)
$token = (irm http://127.0.0.1:8000/token -Method Post -Body "username=admin&password=seclpass" -ContentType "application/x-www-form-urlencoded").access_token
Write-Host "Token ready"

# 2. CREATE Requirement (PROPOSED, MCK area, SYS level, EARS ubiquitous)
$req_body = @{short_name="SYS-REQ-001"; text="system shall authenticate users securely"; area="MCK"; status="proposed"; owner="admin"; level="SYS"; ears_type="ubiquitous"} | ConvertTo-Json
$req_res = irm "http://127.0.0.1:8000/requirements" -Method Post -Headers @{Authorization="Bearer $token"; "Content-Type"="application/json"} -Body $req_body
$req_aid = $req_res.aid
Write-Host "Created Requirement AID: $req_aid"

# 3. LIST all (no filters)
irm "http://127.0.0.1:8000/requirements" -Headers @{Authorization="Bearer $token"}  # Expected: 200, array with 1+ requirements

# 4. FILTER by area (MCK)
irm "http://127.0.0.1:8000/requirements?area=MCK" -Headers @{Authorization="Bearer $token"}  # Expected: 200, array with SYS-REQ-001

# 5. FILTER by status (proposed)
irm "http://127.0.0.1:8000/requirements?status=proposed" -Headers @{Authorization="Bearer $token"}  # Expected: 200, array with SYS-REQ-001

irm "http://127.0.0.1:8000/requirements?owner=admin" -Headers @{Authorization="Bearer $token"}  # Expected: 200, array with SYS-REQ-001

# 7. FILTER by level (SYS)
irm "http://127.0.0.1:8000/requirements?level=SYS" -Headers @{Authorization="Bearer $token"}  # Expected: 200, array with SYS-REQ-001

# 8. FILTER by ears_type (ubiquitous)
irm "http://127.0.0.1:8000/requirements?ears_type=ubiquitous" -Headers @{Authorization="Bearer $token"}  # Expected: 200, array with SYS-REQ-001

# 9. FILTER by area + status + owner + level
irm "http://127.0.0.1:8000/requirements?area=MCK&status=proposed&owner=admin&level=SYS" -Headers @{Authorization="Bearer $token"}  # Expected: 200, array with SYS-REQ-001

# 10. GET single by aid
irm "http://127.0.0.1:8000/requirements/$req_aid" -Headers @{Authorization="Bearer $token"}  # Expected: 200, {"aid": "PROJECT-MCK-SYS-REQ-001", "text": "system shall authenticate users securely", ...}

# 11. UPDATE (partial: change status to verified post-workshop)
$update_body = @{status="verified"} | ConvertTo-Json
$update_res = irm "http://127.0.0.1:8000/requirements/$req_aid" -Method Put -Headers @{Authorization="Bearer $token"; "Content-Type"="application/json"} -Body $update_body
$update_res  # Expected: 200, updated requirement with "status": "verified"

# 12. GET updated (verify)
irm "http://127.0.0.1:8000/requirements/$req_aid" -Headers @{Authorization="Bearer $token"}  # Expected: 200, "status": "verified"

# 13. DELETE (de-scope)
irm "http://127.0.0.1:8000/requirements/$req_aid" -Method Delete -Headers @{Authorization="Bearer $token"}  # Expected: 204

# 14. GET deleted (404)
irm "http://127.0.0.1:8000/requirements/$req_aid" -Headers @{Authorization="Bearer $token"}  # Expected: 404 "Requirement not found"

# 15. Error cases
irm "http://127.0.0.1:8000/requirements/invalid-aid" -Headers @{Authorization="Bearer $token"}  # Expected: 404